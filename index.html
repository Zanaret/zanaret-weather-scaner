<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML File Scanner with Station Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="url"]:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
        }
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .result-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .result-item a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        .result-item a:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            margin-top: 20px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin-top: 20px;
        }
        .stats {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
        }
        
        /* Map Styles */
        .map-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .map-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .map-controls button {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }
        .station-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .station-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        .station-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .station-item:hover {
            background-color: #f0f0f0;
        }
        .station-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-weight: bold;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç XML File, Timestamp & Station Code Scanner with Interactive Map</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Enter a webpage URL to scan for XML files, timestamp patterns (YYYYMMDDTHHMMSS.MSS), and station codes (s0000XXX). View stations on an interactive map.
        </p>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('scanner')">Scanner</button>
            <button class="tab" onclick="showTab('map')">Station Map</button>
        </div>
        
        <div id="scanner-tab" class="tab-content active">
            <div class="input-group">
                <label for="urlInput">Webpage URL:</label>
                <input type="url" id="urlInput" placeholder="https://dd.meteo.gc.ca/today/citypage_weather/QC/" value="https://dd.meteo.gc.ca/today/citypage_weather/QC/">
            </div>
            
            <div class="input-group">
                <label for="hourSelect">Hour (24h format):</label>
                <select id="hourSelect">
                    <option value="current">üïê Current Hour (Auto-detect)</option>
                    <option value="">All hours</option>
                    <option value="00">00 (Midnight)</option>
                    <option value="01">01 (1 AM)</option>
                    <option value="02">02 (2 AM)</option>
                    <option value="03">03 (3 AM)</option>
                    <option value="04">04 (4 AM)</option>
                    <option value="05">05 (5 AM)</option>
                    <option value="06">06 (6 AM)</option>
                    <option value="07">07 (7 AM)</option>
                    <option value="08">08 (8 AM)</option>
                    <option value="09">09 (9 AM)</option>
                    <option value="10">10 (10 AM)</option>
                    <option value="11">11 (11 AM)</option>
                    <option value="12">12 (Noon)</option>
                    <option value="13">13 (1 PM)</option>
                    <option value="14">14 (2 PM)</option>
                    <option value="15">15 (3 PM)</option>
                    <option value="16">16 (4 PM)</option>
                    <option value="17">17 (5 PM)</option>
                    <option value="18">18 (6 PM)</option>
                    <option value="19">19 (7 PM)</option>
                    <option value="20">20 (8 PM)</option>
                    <option value="21">21 (9 PM)</option>
                    <option value="22">22 (10 PM)</option>
                    <option value="23">23 (11 PM)</option>
                </select>
            </div>
            
            <button onclick="scanForXML()" id="scanBtn">Scan for XML Files, Timestamps & Station Codes</button>
            <button onclick="scanCurrentHour()" id="scanCurrentBtn" style="margin-top: 10px; background-color: #ffc107; color: #000;">üïê Scan Current Hour</button>
            <button onclick="startAutoRefresh()" id="autoRefreshBtn" style="margin-top: 10px; background-color: #17a2b8;">üîÑ Auto-Refresh Current Hour</button>
            <button onclick="scanAllHours()" id="scanAllBtn" style="margin-top: 10px; background-color: #28a745;">Scan All Hours</button>
            
            <div id="results" class="results"></div>
        </div>
        
        <div id="map-tab" class="tab-content">
            <div class="map-controls">
                <button onclick="centerMapOnQuebec()" style="background-color: #17a2b8;">üìç Center on Quebec</button>
            </div>
            
            <div id="map" class="map-container"></div>
            
            <div class="station-info">
                <h3>Station Information</h3>
                <div id="stationCount">No stations loaded</div>
                <div id="selectedStation">No station selected</div>
            </div>
            
            <div class="station-list" id="stationList">
                <p style="text-align: center; color: #666;">Click "Load Station Map" to view stations</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map = null;
        let stationMarkers = [];
        let stationData = [];
        let selectedMarker = null;
        
        // Station data (embedded from stations.txt)
        const stationCoordinates = `<stations>
<name code="s0000354" lat="48.80N" lon="79.21O">La Sarre</name>
<name code="s0000270" lat="48.88N" lon="72.23O">Dolbeau-Mistassini</name>
<name code="s0000314" lat="48.50N" lon="64.16O">Perc√©</name>
<name code="s0000315" lat="48.35N" lon="64.68O">Chandler</name>
<name code="s0000182" lat="46.68N" lon="71.74O">Donnacona</name>
<name code="s0000061" lat="45.48N" lon="74.30O">Rigaud</name>
<name code="s0000062" lat="45.42N" lon="74.04O">Saint-Lazare</name>
<name code="s0000361" lat="45.54N" lon="73.90O">Deux-Montagnes</name>
<name code="s0000362" lat="45.40N" lon="74.03O">Vaudreuil-Dorion</name>
<name code="s0000363" lat="45.42N" lon="74.04O">Pincourt</name>
<name code="s0000185" lat="46.21N" lon="70.77O">Beauceville</name>
<name code="s0000186" lat="45.58N" lon="70.89O">Lac-M√©gantic</name>
<name code="s0000187" lat="46.13N" lon="70.36O">Saint-Georges</name>
<name code="s0000416" lat="46.81N" lon="71.17O">L√©vis</name>
<name code="s0000194" lat="47.44N" lon="70.46O">Charlevoix</name>
<name code="s0000320" lat="49.16N" lon="66.38O">Cap Chat</name>
<name code="s0000321" lat="48.93N" lon="66.28O">Gasp√©sie (Parc national)</name>
<name code="s0000322" lat="49.12N" lon="66.49O">Sainte-Anne-Des-Monts</name>
<name code="s0000578" lat="60.81N" lon="78.20O">Akulivik</name>
<name code="s0000342" lat="47.44N" lon="70.51O">Baie-Saint-Paul</name>
<name code="s0000295" lat="48.15N" lon="69.72O">Tadoussac</name>
<name code="s0000284" lat="47.75N" lon="71.25O">Laurentides (R√©serve faunique)</name>
<name code="s0000268" lat="48.01N" lon="65.34O">New Carlisle</name>
<name code="s0000269" lat="48.04N" lon="65.49O">Bonaventure</name>
<name code="s0000245" lat="47.33N" lon="77.00O">La V√©rendrye (R√©serve faunique)</name>
<name code="s0000717" lat="48.10N" lon="77.80O">Val-d'Or</name>
<name code="s0000718" lat="48.47N" lon="78.14O">Amos</name>
<name code="s0000345" lat="45.27N" lon="72.15O">Magog</name>
<name code="s0000393" lat="48.45N" lon="68.52O">Rimouski</name>
<name code="s0000244" lat="46.37N" lon="75.98O">Maniwaki</name>
<name code="s0000246" lat="46.55N" lon="75.50O">Mont-Laurier</name>
<name code="s0000174" lat="47.62N" lon="61.52O">√éles-de-la-Madeleine</name>
<name code="s0000333" lat="47.65N" lon="70.15O">La Malbaie</name>
<name code="s0000334" lat="46.98N" lon="70.55O">Montmagny</name>
<name code="s0000335" lat="47.56N" lon="69.87O">Kamouraska</name>
<name code="s0000336" lat="47.10N" lon="70.35O">L'Islet</name>
<name code="s0000046" lat="45.39N" lon="73.52O">Candiac</name>
<name code="s0000048" lat="45.40N" lon="73.56O">La Prairie</name>
<name code="s0000049" lat="45.38N" lon="73.58O">Saint-Constant</name>
<name code="s0000050" lat="45.40N" lon="73.56O">Sainte-Catherine</name>
<name code="s0000059" lat="45.63N" lon="72.96O">Saint-Hyacinthe</name>
<name code="s0000180" lat="45.68N" lon="73.43O">Varennes</name>
<name code="s0000551" lat="45.53N" lon="73.48O">Longueuil</name>
<name code="s0000552" lat="45.44N" lon="73.25O">Richelieu</name>
<name code="s0000553" lat="45.36N" lon="73.48O">Carignan</name>
<name code="s0000554" lat="45.45N" lon="73.29O">Chambly</name>
<name code="s0000555" lat="45.55N" lon="73.32O">Mont-Saint-Hilaire</name>
<name code="s0000556" lat="45.54N" lon="73.21O">Otterburn Park</name>
<name code="s0000557" lat="45.65N" lon="73.30O">Saint-Amable</name>
<name code="s0000558" lat="45.55N" lon="73.32O">Saint-Basile Le Grand</name>
<name code="s0000559" lat="45.59N" lon="73.34O">Sainte-Julie</name>
<name code="s0000769" lat="45.38N" lon="73.55O">Delson</name>
<name code="s0000483" lat="49.21N" lon="68.18O">Baie-Comeau</name>
<name code="s0000484" lat="48.74N" lon="69.09O">Forestville</name>
<name code="s0000610" lat="50.18N" lon="61.81O">Natashquan</name>
<name code="s0000541" lat="50.22N" lon="63.17O">Havre St-Pierre</name>
<name code="s0000574" lat="61.60N" lon="71.96O">Kangiqsujuaq</name>
<name code="s0000575" lat="61.60N" lon="71.96O">Lac Raglan</name>
<name code="s0000617" lat="49.76N" lon="77.63O">Matagami</name>
<name code="s0000711" lat="60.03N" lon="77.27O">Puvirnituq</name>
<name code="s0000586" lat="59.30N" lon="69.60O">Aupaluk</name>
<name code="s0000598" lat="49.92N" lon="74.37O">Chibougamau</name>
<name code="s0000738" lat="52.79N" lon="67.09O">Fermont</name>
<name code="s0000542" lat="55.30N" lon="77.74O">Kuujjuarapik</name>
<name code="s0000681" lat="45.40N" lon="71.90O">Sherbrooke</name>
<name code="s0000682" lat="45.60N" lon="71.96O">Val-des-Sources</name>
<name code="s0000319" lat="49.25N" lon="65.57O">Grande-Vall√©e</name>
<name code="s0000810" lat="48.10N" lon="66.11O">Pointe-√†-la-Croix</name>
<name code="s0000811" lat="48.10N" lon="66.11O">Carleton-sur-Mer</name>
<name code="s0000124" lat="47.44N" lon="72.78O">La Tuque</name>
<name code="s0000125" lat="47.08N" lon="72.91O">Mauricie</name>
<name code="s0000052" lat="45.41N" lon="72.73O">Granby</name>
<name code="s0000063" lat="45.28N" lon="72.98O">Farnham</name>
<name code="s0000028" lat="48.36N" lon="69.42O">Escoumins</name>
<name code="s0000205" lat="46.69N" lon="71.36O">Berni√®res</name>
<name code="s0000611" lat="45.49N" lon="75.66O">Gatineau</name>
<name code="s0000612" lat="45.70N" lon="74.98O">Papineau</name>
<name code="s0000614" lat="45.65N" lon="75.66O">Val-des-Monts</name>
<name code="s0000615" lat="45.50N" lon="75.78O">Chelsea</name>
<name code="s0000699" lat="58.69N" lon="69.94O">Tasiujaq</name>
<name code="s0000060" lat="45.43N" lon="73.16O">Marieville</name>
<name code="s0000202" lat="45.31N" lon="73.27O">Saint-Jean-sur-Richelieu</name>
<name code="s0000203" lat="45.34N" lon="73.51O">Saint-Luc</name>
<name code="s0000673" lat="48.51N" lon="72.23O">Roberval</name>
<name code="s0000674" lat="48.63N" lon="72.32O">Lac-Saint-Jean</name>
<name code="s0000675" lat="48.63N" lon="72.32O">Saint-F√©licien</name>
<name code="s0000055" lat="46.01N" lon="73.92O">Pr√©vost</name>
<name code="s0000056" lat="45.82N" lon="73.96O">Sainte-Sophie</name>
<name code="s0000058" lat="46.01N" lon="73.92O">Saint-Sauveur</name>
<name code="s0000600" lat="45.65N" lon="74.08O">Mirabel</name>
<name code="s0000601" lat="45.82N" lon="73.96O">Saint-J√©r√¥me</name>
<name code="s0000602" lat="45.65N" lon="74.34O">Lachute</name>
<name code="s0000603" lat="45.68N" lon="73.89O">Blainville</name>
<name code="s0000604" lat="45.61N" lon="73.84O">Boisbriand</name>
<name code="s0000605" lat="45.67N" lon="73.79O">Lorraine</name>
<name code="s0000606" lat="45.58N" lon="73.93O">Rosem√®re</name>
<name code="s0000607" lat="45.76N" lon="73.81O">Sainte-Anne-Des-Plaines</name>
<name code="s0000608" lat="45.58N" lon="73.93O">Sainte-Th√©r√®se</name>
<name code="s0000609" lat="45.57N" lon="73.88O">Saint-Eustache</name>
<name code="s0000599" lat="56.55N" lon="76.55O">Umiujaq</name>
<name code="s0000793" lat="62.21N" lon="75.65O">Salluit</name>
<name code="s0000579" lat="51.47N" lon="78.76O">Waskaganish</name>
<name code="s0000719" lat="58.11N" lon="68.40O">Kuujjuaq</name>
<name code="s0000532" lat="53.79N" lon="77.61O">La Grande Rivi√®re</name>
<name code="s0000580" lat="53.79N" lon="77.61O">Baie-James</name>
<name code="s0000544" lat="61.05N" lon="69.63O">Quaqtaq</name>
<name code="s0000346" lat="46.39N" lon="72.75O">Trois-Rivi√®res</name>
<name code="s0000347" lat="46.34N" lon="72.43O">B√©cancour</name>
<name code="s0000348" lat="46.25N" lon="72.95O">Louiseville</name>
<name code="s0000459" lat="46.44N" lon="73.17O">Lanaudi√®re</name>
<name code="s0000054" lat="46.06N" lon="71.96O">Victoriaville</name>
<name code="s0000480" lat="60.02N" lon="70.01O">Kangirsuk</name>
<name code="s0000204" lat="46.82N" lon="71.27O">Vanier</name>
<name code="s0000620" lat="46.81N" lon="71.22O">Qu√©bec</name>
<name code="s0000535" lat="48.83N" lon="64.57O">Gasp√©</name>
<name code="s0000536" lat="48.83N" lon="64.57O">Forillon</name>
<name code="s0000537" lat="48.83N" lon="64.57O">Forillon ( Parc national)</name>
<name code="s0000044" lat="45.31N" lon="73.86O">Beauharnois</name>
<name code="s0000635" lat="45.53N" lon="73.56O">Montr√©al</name>
<name code="s0000712" lat="45.60N" lon="73.67O">Laval</name>
<name code="s0000800" lat="50.22N" lon="66.37O">Sept-√éles</name>
<name code="s0000801" lat="50.03N" lon="66.86O">Port-Cartier</name>
<name code="s0000563" lat="62.42N" lon="77.92O">Ivujivik</name>
<name code="s0000591" lat="58.70N" lon="65.95O">Kangiqsualujjuaq</name>
<name code="s0000709" lat="46.56N" lon="72.74O">Shawinigan</name>
<name code="s0000406" lat="48.47N" lon="67.42O">Amqui</name>
<name code="s0000407" lat="47.98N" lon="66.96O">Matap√©dia</name>
<name code="s0000408" lat="47.98N" lon="66.96O">Vall√©e de la Matap√©dia</name>
<name code="s0000253" lat="47.74N" lon="69.54O">Rivi√®re-du-Loup</name>
<name code="s0000254" lat="48.12N" lon="69.17O">Trois-Pistoles</name>
<name code="s0000255" lat="47.67N" lon="68.98O">T√©miscouata</name>
<name code="s0000121" lat="50.47N" lon="59.61O">Chevery</name>
<name code="s0000486" lat="48.32N" lon="71.13O">Bagotville</name>
<name code="s0000353" lat="48.24N" lon="79.02O">Rouyn-Noranda</name>
<name code="s0000783" lat="48.59N" lon="68.19O">Mont-Joli</name>
<name code="s0000784" lat="48.84N" lon="67.53O">Matane</name>
<name code="s0000064" lat="46.10N" lon="71.30O">Thetford Mines</name>
<name code="s0000094" lat="50.29N" lon="64.04O">Mingan</name>
<name code="s0000085" lat="47.39N" lon="78.70O">T√©miscamingue</name>
<name code="s0000051" lat="45.25N" lon="73.80O">Saint-R√©mi</name>
<name code="s0000296" lat="45.13N" lon="71.80O">Coaticook</name>
<name code="s0000260" lat="46.23N" lon="72.61O">Nicolet</name>
<name code="s0000098" lat="45.25N" lon="74.12O">Salaberry-de-Valleyfield</name>
<name code="s0000099" lat="45.09N" lon="74.18O">Huntingdon</name>
<name code="s0000742" lat="45.18N" lon="74.24O">Saint-Timoth√©e</name>
<name code="s0000057" lat="46.00N" lon="73.73O">Saint-Lin-Laurentides</name>
<name code="s0000142" lat="45.82N" lon="73.43O">L'Assomption</name>
<name code="s0000143" lat="46.09N" lon="73.19O">Berthierville</name>
<name code="s0000144" lat="45.85N" lon="73.24O">Contrecoeur</name>
<name code="s0000145" lat="45.75N" lon="73.60O">Mascouche</name>
<name code="s0000147" lat="46.04N" lon="73.11O">Sorel-Tracy</name>
<name code="s0000148" lat="46.04N" lon="73.11O">Tracy</name>
<name code="s0000149" lat="45.70N" lon="73.58O">Le Gardeur</name>
<name code="s0000290" lat="45.70N" lon="73.63O">Terrebonne</name>
<name code="s0000721" lat="46.02N" lon="73.44O">Joliette</name>
<name code="s0000755" lat="45.74N" lon="73.46O">Repentigny</name>
<name code="s0000097" lat="49.82N" lon="64.35O">Port-Menier</name>
<name code="s0000027" lat="48.96N" lon="65.50O">Murdochville</name>
<name code="s0000029" lat="46.68N" lon="73.92O">Saint-Michel-des-Saints</name>
<name code="s0000053" lat="45.20N" lon="72.75O">Cowansville</name>
<name code="s0000123" lat="50.64N" lon="68.73O">Manicouagan</name>
<name code="s0000163" lat="45.11N" lon="72.62O">Sutton</name>
<name code="s0000197" lat="48.54N" lon="71.65O">Alma</name>
<name code="s0000211" lat="48.42N" lon="71.07O">Saguenay</name>
<name code="s0000213" lat="46.12N" lon="74.60O">Mont-Tremblant</name>
<name code="s0000214" lat="45.88N" lon="74.57O">Sainte-Agathe</name>
<name code="s0000261" lat="45.88N" lon="72.51O">Drummondville</name>
<name code="s0000262" lat="45.92N" lon="72.74O">Saint-Nic√©phore</name>
<name code="s0000287" lat="47.92N" lon="74.62O">Parent</name>
<name code="s0000288" lat="48.46N" lon="73.68O">Gouin (R√©servoir)</name>
<name code="s0000478" lat="53.86N" lon="73.49O">La Grande-Quatre</name>
<name code="s0000494" lat="51.43N" lon="57.13O">Blanc-Sablon</name>
<name code="s0000577" lat="54.80N" lon="66.82O">Schefferville</name>
<name code="s0000613" lat="45.91N" lon="77.07O">Pontiac</name>
<name code="s0000627" lat="58.46N" lon="78.10O">Inukjuak</name>
<station code="wpd" lat="47.57N" lon="71.23O">L'√âtape</station>
</stations>`;

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Initialize map if switching to map tab
            if (tabName === 'map' && !map) {
                initializeMap();
                // Auto-load stations when map tab is opened
                setTimeout(() => {
                    loadStationData();
                }, 100);
            }
        }
        
        // Initialize the map
        function initializeMap() {
            if (map) return;
            
            map = L.map('map').setView([52.0, -72.0], 6); // Center on Quebec
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add scale control
            L.control.scale().addTo(map);
        }
        
        // Parse station coordinates from XML format
        function parseStationCoordinates(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, 'text/xml');
            
            const parsedStations = [];
            
            // Parse both 'name' and 'station' tags
            const nameStations = xmlDoc.getElementsByTagName('name');
            const stationTags = xmlDoc.getElementsByTagName('station');
            
            // Combine both collections
            const allStations = [...nameStations, ...stationTags];
            
            for (let i = 0; i < allStations.length; i++) {
                const station = allStations[i];
                const code = station.getAttribute('code');
                const lat = station.getAttribute('lat');
                const lon = station.getAttribute('lon');
                const name = station.textContent;
                
                if (code && lat && lon) {
                    // Parse latitude (e.g., "48.80N" -> 48.80)
                    const latValue = parseFloat(lat.replace(/[NS]$/, ''));
                    const latDirection = lat.slice(-1);
                    const finalLat = latDirection === 'S' ? -latValue : latValue;
                    
                    // Parse longitude (e.g., "79.21O" -> -79.21, O = West)
                    const lonValue = parseFloat(lon.replace(/[EO]$/, ''));
                    const lonDirection = lon.slice(-1);
                    const finalLon = lonDirection === 'O' ? -lonValue : lonValue;
                    
                    parsedStations.push({
                        code: code,
                        name: name,
                        lat: finalLat,
                        lon: finalLon,
                        originalLat: lat,
                        originalLon: lon
                    });
                }
            }
            
            return parsedStations;
        }
        
        // Load station data and display on map
        function loadStationData() {
            if (!map) {
                initializeMap();
            }
            
            // Clear existing markers
            clearMap();
            
            // Parse station data
            stationData = parseStationCoordinates(stationCoordinates);
            
            // Add markers to map
            stationData.forEach(station => {
                const marker = L.marker([station.lat, station.lon])
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h4>${station.name}</h4>
                            <p><strong>Code:</strong> ${station.code}</p>
                            <p><strong>Coordinates:</strong> ${station.originalLat}, ${station.originalLon}</p>
                            <div style="margin: 10px 0;">
                                <a href="?station=${station.code}" style="background: #28a745; color: white; text-decoration: none; padding: 5px 10px; border-radius: 3px; display: inline-block; margin: 2px;">
                                    üåê Direct Link
                                </a>
                                <button onclick="scanStation('${station.code}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">
                                    üîç Scan Station
                                </button>
                            </div>
                        </div>
                    `)
                    .addTo(map);
                
                stationMarkers.push(marker);
                
                // Add click event to highlight station
                marker.on('click', function() {
                    selectStation(station);
                });
            });
            
            // Update station count
            document.getElementById('stationCount').innerHTML = `
                <strong>${stationData.length}</strong> weather stations loaded
            `;
            
            // Update station list
            updateStationList();
            
            // Fit map to show all stations
            if (stationData.length > 0) {
                const group = new L.featureGroup(stationMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Select a station
        function selectStation(station) {
            // Remove previous selection
            if (selectedMarker) {
                selectedMarker.setIcon(L.Icon.Default.prototype);
            }
            
            // Highlight selected marker
            const marker = stationMarkers.find(m => 
                m.getLatLng().lat === station.lat && m.getLatLng().lng === station.lon
            );
            
            if (marker) {
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #ff4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                marker.setIcon(customIcon);
                selectedMarker = marker;
            }
            
            // Update station info
            document.getElementById('selectedStation').innerHTML = `
                <strong>Selected:</strong> ${station.name} (${station.code})<br>
                <strong>Coordinates:</strong> ${station.originalLat}, ${station.originalLon}
            `;
            
            // Highlight in station list
            highlightStationInList(station.code);
        }
        
        // Highlight station in the list
        function highlightStationInList(stationCode) {
            const stationItems = document.querySelectorAll('.station-item');
            stationItems.forEach(item => item.classList.remove('selected'));
            
            const selectedItem = document.querySelector(`[data-station="${stationCode}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Update station list
        function updateStationList() {
            const stationList = document.getElementById('stationList');
            
            if (stationData.length === 0) {
                stationList.innerHTML = '<p style="text-align: center; color: #666;">No stations loaded</p>';
                return;
            }
            
            let listHTML = '';
            stationData.sort((a, b) => a.name.localeCompare(b.name)).forEach(station => {
                const stationUrl = window.location.origin + window.location.pathname + '?station=' + station.code;
                listHTML += `
                    <div class="station-item" data-station="${station.code}">
                        <div onclick="selectStationFromList('${station.code}')" style="flex: 1; cursor: pointer;">
                            <strong>${station.name}</strong><br>
                            <small>${station.code} - ${station.originalLat}, ${station.originalLon}</small>
                        </div>
                        <code onclick="selectText(this)" style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 12px; border: 1px solid #dee2e6; color: #495057; min-width: 200px; cursor: pointer; transition: background-color 0.2s; display: inline-block; text-align: left; user-select: all;" title="Click to select all">${stationUrl}</code>
                    </div>
                `;
            });
            
            stationList.innerHTML = listHTML;
        }
        
        // Select station from list
        function selectStationFromList(stationCode) {
            const station = stationData.find(s => s.code === stationCode);
            if (station) {
                selectStation(station);
                
                // Center map on station
                map.setView([station.lat, station.lon], 10);
            }
        }
        
        // Center map on Quebec
        function centerMapOnQuebec() {
            if (map) {
                map.setView([52.0, -72.0], 6);
            }
        }
        
        // Clear map
        function clearMap() {
            if (map) {
                stationMarkers.forEach(marker => map.removeLayer(marker));
                stationMarkers = [];
            }
            selectedMarker = null;
            stationData = [];
            
            document.getElementById('stationCount').innerHTML = 'No stations loaded';
            document.getElementById('selectedStation').innerHTML = 'No station selected';
            document.getElementById('stationList').innerHTML = '<p style="text-align: center; color: #666;">Click "Load Station Map" to view stations</p>';
        }
        
        // Export station data
        function exportStationData() {
            if (stationData.length === 0) {
                alert('No station data to export. Please load the station map first.');
                return;
            }
            
            const csvContent = [
                ['Station Code', 'Station Name', 'Latitude', 'Longitude', 'Original Lat', 'Original Lon'],
                ...stationData.map(station => [
                    station.code,
                    station.name,
                    station.lat,
                    station.lon,
                    station.originalLat,
                    station.originalLon
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'weather_stations.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Select all text in an element
        function selectText(element) {
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        // Scan a specific station
        function scanStation(stationCode) {
            // Switch to scanner tab
            showTab('scanner');
            
            // Set the station code in the input
            const stationInput = document.getElementById('stationInput');
            if (stationInput) {
                stationInput.value = stationCode;
                redirectToStation();
            } else {
                // If station input doesn't exist, create it
                addStationRedirectUI();
                setTimeout(() => {
                    const newStationInput = document.getElementById('stationInput');
                    if (newStationInput) {
                        newStationInput.value = stationCode;
                        redirectToStation();
                    }
                }, 100);
            }
        }

        async function scanForXML() {
            const urlInput = document.getElementById('urlInput');
            const hourSelect = document.getElementById('hourSelect');
            const scanBtn = document.getElementById('scanBtn');
            const resultsDiv = document.getElementById('results');
            
            let url = urlInput.value.trim();
            const selectedHour = hourSelect.value;
            
            // If "current" is selected, get the current hour
            if (selectedHour === 'current') {
                const now = new Date();
                const currentHour = now.getUTCHours().toString().padStart(2, '0');
                url = url.endsWith('/') ? url + currentHour + '/' : url + '/' + currentHour + '/';
            }
            // If a specific hour is selected, append it to the URL
            else if (selectedHour) {
                url = url.endsWith('/') ? url + selectedHour + '/' : url + '/' + selectedHour + '/';
            }
            
            if (!url) {
                showError('Please enter a valid URL');
                return;
            }
            
            if (!isValidUrl(url)) {
                showError('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            // Disable button and show loading
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanning...';
            resultsDiv.innerHTML = '<div class="loading">Scanning webpage for XML files and timestamps...</div>';
            
            try {
                // Use a CORS proxy to bypass CORS restrictions
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(url));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const htmlContent = await response.text();
                const results = findXMLFiles(htmlContent, url);
                
                displayResults(results, url);
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to scan the webpage: ${error.message}. This might be due to CORS restrictions or the website not being accessible.`);
            } finally {
                // Re-enable button
                scanBtn.disabled = false;
                scanBtn.textContent = 'Scan for XML Files & Timestamps';
            }
        }
        
        function findXMLFiles(htmlContent, baseUrl) {
            const xmlFiles = [];
            const baseUrlObj = new URL(baseUrl);
            
            // Regular expressions to find XML file references
            const patterns = [
                // Direct XML file links
                /href=["']([^"']*\.xml)["']/gi,
                /src=["']([^"']*\.xml)["']/gi,
                // XML file references in various contexts
                /["']([^"']*\.xml)["']/gi,
                // XML content type references
                /content-type["']?\s*:\s*["']?application\/xml["']?/gi,
                // XML namespace declarations
                /xmlns=["']([^"']*)["']/gi,
                // XML processing instructions
                /<\?xml[^>]*\?>/gi,
                // XML tags
                /<[^>]*xml[^>]*>/gi
            ];
            
            // Regular expression to find timestamp patterns (YYYYMMDDTHHMMSS.MSS)
            const timestampPattern = /(\d{8}T\d{6}\.\d{3})/g;
            
            // Regular expression to find station codes (s0000XXX)
            const stationCodePattern = /(s\d{7})/gi;
            
            // Find all timestamps in the content
            const timestamps = [];
            let timestampMatch;
            while ((timestampMatch = timestampPattern.exec(htmlContent)) !== null) {
                const timestamp = timestampMatch[1];
                const parsedTime = parseTimestamp(timestamp);
                timestamps.push({
                    raw: timestamp,
                    parsed: parsedTime,
                    context: getContext(htmlContent, timestampMatch.index, 100)
                });
            }
            
            // Find all station codes in the content
            const stationCodes = [];
            let stationMatch;
            while ((stationMatch = stationCodePattern.exec(htmlContent)) !== null) {
                const stationCode = stationMatch[1];
                const parsedStation = parseStationCode(stationCode);
                stationCodes.push({
                    raw: stationCode,
                    parsed: parsedStation,
                    context: getContext(htmlContent, stationMatch.index, 100)
                });
            }
            
            // Find all XML file links
            patterns.forEach((pattern, index) => {
                let match;
                while ((match = pattern.exec(htmlContent)) !== null) {
                    if (index < 3 && match[1]) { // Only process file patterns
                        let xmlUrl = match[1];
                        
                        // Convert relative URLs to absolute
                        if (xmlUrl.startsWith('/')) {
                            xmlUrl = baseUrlObj.origin + xmlUrl;
                        } else if (!xmlUrl.startsWith('http')) {
                            xmlUrl = new URL(xmlUrl, baseUrl).href;
                        }
                        
                        // Check if it's a valid XML file URL
                        if (xmlUrl.endsWith('.xml') || xmlUrl.includes('.xml')) {
                            xmlFiles.push({
                                url: xmlUrl,
                                type: 'XML File Link',
                                context: getContext(htmlContent, match.index, 100)
                            });
                        }
                    } else if (index >= 3) { // XML content references
                        xmlFiles.push({
                            url: 'Found in page content',
                            type: index === 3 ? 'XML Content-Type Reference' : 
                                  index === 4 ? 'XML Namespace Declaration' :
                                  index === 5 ? 'XML Processing Instruction' : 'XML Tag',
                            context: getContext(htmlContent, match.index, 100)
                        });
                    }
                }
            });
            
            // Remove duplicates
            const uniqueFiles = [];
            const seen = new Set();
            
            xmlFiles.forEach(file => {
                // Only include _fr.xml files
                if (!file.url.endsWith('_fr.xml')) return;
                const key = file.url + file.type;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueFiles.push(file);
                }
            });
            
            // Remove duplicate timestamps
            const uniqueTimestamps = [];
            const seenTimestamps = new Set();
            
            timestamps.forEach(timestamp => {
                if (!seenTimestamps.has(timestamp.raw)) {
                    seenTimestamps.add(timestamp.raw);
                    uniqueTimestamps.push(timestamp);
                }
            });
            
            // Remove duplicate station codes
            const uniqueStationCodes = [];
            const seenStationCodes = new Set();
            
            stationCodes.forEach(station => {
                if (!seenStationCodes.has(station.raw)) {
                    seenStationCodes.add(station.raw);
                    uniqueStationCodes.push(station);
                }
            });
            
            return {
                xmlFiles: uniqueFiles,
                timestamps: uniqueTimestamps,
                stationCodes: uniqueStationCodes
            };
        }
        
        function getContext(htmlContent, index, length) {
            const start = Math.max(0, index - length);
            const end = Math.min(htmlContent.length, index + length);
            return htmlContent.substring(start, end).replace(/\s+/g, ' ').trim();
        }
        
        function parseTimestamp(timestamp) {
            // Parse timestamp in format YYYYMMDDTHHMMSS.MSS
            // Example: 20250704T170106.502
            
            if (!/^\d{8}T\d{6}\.\d{3}$/.test(timestamp)) {
                return {
                    formatted: 'Invalid format',
                    date: 'Invalid',
                    time: 'Invalid',
                    milliseconds: 'Invalid'
                };
            }
            
            const year = timestamp.substring(0, 4);
            const month = timestamp.substring(4, 6);
            const day = timestamp.substring(6, 8);
            const hour = timestamp.substring(9, 11);
            const minute = timestamp.substring(11, 13);
            const second = timestamp.substring(13, 15);
            const milliseconds = timestamp.substring(16, 19);
            
            // Format date as YYYY-MM-DD
            const date = `${year}-${month}-${day}`;
            
            // Format time as HH:MM:SS
            const time = `${hour}:${minute}:${second}`;
            
            // Create a formatted display string
            const formatted = `${date} ${time}.${milliseconds}`;
            
            return {
                formatted: formatted,
                date: date,
                time: time,
                milliseconds: milliseconds,
                year: year,
                month: month,
                day: day,
                hour: hour,
                minute: minute,
                second: second
            };
        }
        
        function parseStationCode(stationCode) {
            // Parse station code in format s0000XXX
            // Example: s0000123
            
            if (!/^s\d{7}$/i.test(stationCode)) {
                return {
                    formatted: 'Invalid format',
                    stationNumber: 'Invalid',
                    prefix: 'Invalid'
                };
            }
            
            const prefix = stationCode.substring(0, 1).toLowerCase();
            const stationNumber = stationCode.substring(1);
            
            // Format as s-XXXXXXX
            const formatted = `${prefix}-${stationNumber}`;
            
            return {
                formatted: formatted,
                stationNumber: stationNumber,
                prefix: prefix,
                fullCode: stationCode.toUpperCase()
            };
        }
        
        function displayResults(results, originalUrl) {
            const resultsDiv = document.getElementById('results');
            const { xmlFiles, timestamps, stationCodes } = results;
            
            // Display consolidated results
            if (xmlFiles.length === 0 && timestamps.length === 0 && stationCodes.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>No XML files, timestamps, or station codes found</h3>
                        <p>The webpage at <strong>${originalUrl}</strong> doesn't appear to contain any XML file references, timestamp patterns, or station codes.</p>
                    </div>
                `;
                return;
            }
            
            // Combine all information into consolidated cards
            const consolidatedResults = consolidateResults(xmlFiles, timestamps, stationCodes);
            
            let resultsHTML = `
                <div class="stats">
                    <h3>Scan Results</h3>
                    <p>Found <strong>${xmlFiles.length}</strong> XML files, <strong>${timestamps.length}</strong> timestamps, and <strong>${stationCodes.length}</strong> station codes on <strong>${originalUrl}</strong></p>
                    <p>Showing <strong>${consolidatedResults.length}</strong> consolidated results</p>
                </div>
            `;
            
            consolidatedResults.forEach((result, index) => {
                resultsHTML += `
                    <div class="result-item">
                        <h3>${index + 1}. ${result.title}</h3>
                        ${result.xmlFile ? `<p><strong>Latest XML File:</strong> <a href="${result.xmlFile.url}" target="_blank">${result.xmlFile.url}</a></p>` : ''}
                        ${result.stationCode ? `<p><strong>Station Code:</strong> ${result.stationCode.parsed.formatted} (${result.stationCode.parsed.stationNumber})</p>` : ''}
                        ${result.timestamp ? `<p><strong>Timestamp:</strong> ${result.timestamp.parsed.formatted}</p>` : ''}
                        ${result.context ? `<p><strong>Context:</strong> ${result.context}</p>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = resultsHTML;
        }
        
        function consolidateResults(xmlFiles, timestamps, stationCodes) {
            const consolidated = [];
            
            // Group by station code if available
            const stationGroups = new Map();
            
            // First, group XML files by station code
            xmlFiles.forEach(file => {
                // Extract station code from XML file URL or context
                const stationMatch = file.url.match(/(s\d{7})/i) || file.context.match(/(s\d{7})/i);
                const stationCode = stationMatch ? stationMatch[1] : 'unknown';
                
                if (!stationGroups.has(stationCode)) {
                    stationGroups.set(stationCode, {
                        stationCode: null,
                        xmlFiles: [],
                        timestamps: [],
                        context: ''
                    });
                }
                
                stationGroups.get(stationCode).xmlFiles.push(file);
            });
            
            // Add station codes to groups
            stationCodes.forEach(station => {
                const stationCode = station.raw;
                if (!stationGroups.has(stationCode)) {
                    stationGroups.set(stationCode, {
                        stationCode: null,
                        xmlFiles: [],
                        timestamps: [],
                        context: ''
                    });
                }
                stationGroups.get(stationCode).stationCode = station;
            });
            
            // Add timestamps to groups
            timestamps.forEach(timestamp => {
                // Try to match timestamp with station code from context
                const stationMatch = timestamp.context.match(/(s\d{7})/i);
                const stationCode = stationMatch ? stationMatch[1] : 'unknown';
                
                if (!stationGroups.has(stationCode)) {
                    stationGroups.set(stationCode, {
                        stationCode: null,
                        xmlFiles: [],
                        timestamps: [],
                        context: ''
                    });
                }
                
                stationGroups.get(stationCode).timestamps.push(timestamp);
            });
            
            // Create consolidated results for each station
            stationGroups.forEach((group, stationCode) => {
                if (group.xmlFiles.length > 0 || group.stationCode || group.timestamps.length > 0) {
                    // Get the latest XML file (by URL or timestamp in context)
                    const latestXmlFile = group.xmlFiles.length > 0 ? 
                        group.xmlFiles.sort((a, b) => {
                            // Try to extract timestamp from URLs for sorting
                            const aMatch = a.url.match(/(\d{8}T\d{6})/);
                            const bMatch = b.url.match(/(\d{8}T\d{6})/);
                            if (aMatch && bMatch) {
                                return bMatch[1].localeCompare(aMatch[1]); // Latest first
                            }
                            return b.url.localeCompare(a.url); // Fallback to URL comparison
                        })[0] : null;
                    
                    // Get the latest timestamp
                    const latestTimestamp = group.timestamps.length > 0 ? 
                        group.timestamps.sort((a, b) => b.raw.localeCompare(a.raw))[0] : null;
                    
                    const title = group.stationCode ? 
                        `Station ${group.stationCode.parsed.formatted}` : 
                        `Station ${stationCode}`;
                    
                    consolidated.push({
                        title: title,
                        xmlFile: latestXmlFile,
                        stationCode: group.stationCode,
                        timestamp: latestTimestamp,
                        context: latestXmlFile ? latestXmlFile.context : 
                                latestTimestamp ? latestTimestamp.context : 
                                group.stationCode ? group.stationCode.context : ''
                    });
                }
            });
            
            // Sort consolidated results by station code
            consolidated.sort((a, b) => {
                const aCode = a.stationCode ? a.stationCode.parsed.stationNumber : '0000000';
                const bCode = b.stationCode ? b.stationCode.parsed.stationNumber : '0000000';
                return aCode.localeCompare(bCode);
            });
            
            return consolidated;
        }
        
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        async function scanCurrentHour() {
            const urlInput = document.getElementById('urlInput');
            const scanCurrentBtn = document.getElementById('scanCurrentBtn');
            const resultsDiv = document.getElementById('results');
            
            const baseUrl = urlInput.value.trim();
            
            if (!baseUrl) {
                showError('Please enter a valid URL');
                return;
            }
            
            if (!isValidUrl(baseUrl)) {
                showError('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            // Get current hour
            const now = new Date();
            const currentHour = now.getUTCHours().toString().padStart(2, '0');
            const currentTime = now.toUTCString();
            
            // Disable button and show loading
            scanCurrentBtn.disabled = true;
            scanCurrentBtn.textContent = 'Scanning Current Hour...';
            resultsDiv.innerHTML = `<div class="loading">Scanning current hour (${currentHour}) at ${currentTime}...</div>`;
            
            try {
                const hourUrl = baseUrl.endsWith('/') ? baseUrl + currentHour + '/' : baseUrl + '/' + currentHour + '/';
                
                // Use a CORS proxy to bypass CORS restrictions
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(hourUrl));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const htmlContent = await response.text();
                const results = findXMLFiles(htmlContent, hourUrl);
                
                // Add current hour information to results
                results.xmlFiles.forEach(file => {
                    file.hour = currentHour;
                    file.sourceUrl = hourUrl;
                    file.isCurrentHour = true;
                });
                
                results.timestamps.forEach(timestamp => {
                    timestamp.hour = currentHour;
                    timestamp.sourceUrl = hourUrl;
                    timestamp.isCurrentHour = true;
                });
                
                results.stationCodes.forEach(station => {
                    station.hour = currentHour;
                    station.sourceUrl = hourUrl;
                    station.isCurrentHour = true;
                });
                
                displayCurrentHourResults(results, baseUrl, currentHour, currentTime);
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to scan the current hour: ${error.message}. This might be due to CORS restrictions or the website not being accessible.`);
            } finally {
                // Re-enable button
                scanCurrentBtn.disabled = false;
                scanCurrentBtn.textContent = 'üïê Scan Current Hour';
            }
        }
        
        function displayCurrentHourResults(results, baseUrl, currentHour, currentTime) {
            const resultsDiv = document.getElementById('results');
            const { xmlFiles, timestamps, stationCodes } = results;
            
            // Display consolidated results
            if (xmlFiles.length === 0 && timestamps.length === 0 && stationCodes.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>No XML files, timestamps, or station codes found in current hour</h3>
                        <p>No XML files, timestamp patterns, or station codes were found in hour ${currentHour}.</p>
                    </div>
                `;
                return;
            }
            
            // Combine all information into consolidated cards
            const consolidatedResults = consolidateResults(xmlFiles, timestamps, stationCodes);
            
            let resultsHTML = `
                <div class="stats">
                    <h3>üïê Current Hour Scan Complete</h3>
                    <p>Scanned hour <strong>${currentHour}</strong> at <strong>${currentTime}</strong></p>
                    <p>URL: <a href="${baseUrl}${currentHour}/" target="_blank">${baseUrl}${currentHour}/</a></p>
                    <p>Found <strong>${xmlFiles.length}</strong> XML files, <strong>${timestamps.length}</strong> timestamps, and <strong>${stationCodes.length}</strong> station codes</p>
                    <p>Showing <strong>${consolidatedResults.length}</strong> consolidated results</p>
                </div>
            `;
            
            consolidatedResults.forEach((result, index) => {
                resultsHTML += `
                    <div class="result-item">
                        <h3>${index + 1}. ${result.title} (Hour: ${currentHour})</h3>
                        ${result.xmlFile ? `<p><strong>Latest XML File:</strong> <a href="${result.xmlFile.url}" target="_blank">${result.xmlFile.url}</a></p>` : ''}
                        ${result.stationCode ? `<p><strong>Station Code:</strong> ${result.stationCode.parsed.formatted} (${result.stationCode.parsed.stationNumber})</p>` : ''}
                        ${result.timestamp ? `<p><strong>Timestamp:</strong> ${result.timestamp.parsed.formatted}</p>` : ''}
                        ${result.context ? `<p><strong>Context:</strong> ${result.context}</p>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = resultsHTML;
        }
        
        async function scanAllHours() {
            const urlInput = document.getElementById('urlInput');
            const scanAllBtn = document.getElementById('scanAllBtn');
            const resultsDiv = document.getElementById('results');
            
            const baseUrl = urlInput.value.trim();
            
            if (!baseUrl) {
                showError('Please enter a valid URL');
                return;
            }
            
            if (!isValidUrl(baseUrl)) {
                showError('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            // Disable button and show loading
            scanAllBtn.disabled = true;
            scanAllBtn.textContent = 'Scanning All Hours...';
            resultsDiv.innerHTML = '<div class="loading">Scanning all hourly directories...</div>';
            
            const allResults = {
                xmlFiles: [],
                timestamps: [],
                stationCodes: []
            };
            
            const hours = ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', 
                          '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'];
            
            let completedHours = 0;
            
            for (const hour of hours) {
                try {
                    const hourUrl = baseUrl.endsWith('/') ? baseUrl + hour + '/' : baseUrl + '/' + hour + '/';
                    
                    // Update loading message
                    resultsDiv.innerHTML = `<div class="loading">Scanning hour ${hour}... (${completedHours + 1}/24)</div>`;
                    
                    // Use a CORS proxy to bypass CORS restrictions
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(hourUrl));
                    
                    if (response.ok) {
                        const htmlContent = await response.text();
                        const results = findXMLFiles(htmlContent, hourUrl);
                        
                        // Add hour information to results
                        results.xmlFiles.forEach(file => {
                            file.hour = hour;
                            file.sourceUrl = hourUrl;
                        });
                        
                        results.timestamps.forEach(timestamp => {
                            timestamp.hour = hour;
                            timestamp.sourceUrl = hourUrl;
                        });
                        
                        results.stationCodes.forEach(station => {
                            station.hour = hour;
                            station.sourceUrl = hourUrl;
                        });
                        
                        allResults.xmlFiles.push(...results.xmlFiles);
                        allResults.timestamps.push(...results.timestamps);
                        allResults.stationCodes.push(...results.stationCodes);
                    }
                    
                    completedHours++;
                    
                    // Small delay to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Error scanning hour ${hour}:`, error);
                    completedHours++;
                }
            }
            
            // Remove duplicates
            const uniqueXmlFiles = [];
            const uniqueTimestamps = [];
            const uniqueStationCodes = [];
            const seenXml = new Set();
            const seenTimestamps = new Set();
            const seenStationCodes = new Set();
            
            allResults.xmlFiles.forEach(file => {
                const key = file.url + file.type + file.hour;
                if (!seenXml.has(key)) {
                    seenXml.add(key);
                    uniqueXmlFiles.push(file);
                }
            });
            
            allResults.timestamps.forEach(timestamp => {
                const key = timestamp.raw + timestamp.hour;
                if (!seenTimestamps.has(key)) {
                    seenTimestamps.add(key);
                    uniqueTimestamps.push(timestamp);
                }
            });
            
            allResults.stationCodes.forEach(station => {
                const key = station.raw + station.hour;
                if (!seenStationCodes.has(key)) {
                    seenStationCodes.add(key);
                    uniqueStationCodes.push(station);
                }
            });
            
            displayAllHoursResults({
                xmlFiles: uniqueXmlFiles,
                timestamps: uniqueTimestamps,
                stationCodes: uniqueStationCodes
            }, baseUrl);
            
            // Re-enable button
            scanAllBtn.disabled = false;
            scanAllBtn.textContent = 'Scan All Hours';
        }
        
        function displayAllHoursResults(results, baseUrl) {
            const resultsDiv = document.getElementById('results');
            const { xmlFiles, timestamps, stationCodes } = results;
            
            // Display consolidated results
            if (xmlFiles.length === 0 && timestamps.length === 0 && stationCodes.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>No XML files, timestamps, or station codes found</h3>
                        <p>No XML files, timestamp patterns, or station codes were found across all 24 hourly directories.</p>
                    </div>
                `;
                return;
            }
            
            // Combine all information into consolidated cards
            const consolidatedResults = consolidateResults(xmlFiles, timestamps, stationCodes);
            
            let resultsHTML = `
                <div class="stats">
                    <h3>All Hours Scan Complete</h3>
                    <p>Scanned <strong>24 hourly directories</strong> on <strong>${baseUrl}</strong></p>
                    <p>Found <strong>${xmlFiles.length}</strong> XML files, <strong>${timestamps.length}</strong> timestamps, and <strong>${stationCodes.length}</strong> station codes across all hours</p>
                    <p>Showing <strong>${consolidatedResults.length}</strong> consolidated results (latest XML file per station)</p>
                </div>
            `;
            
            consolidatedResults.forEach((result, index) => {
                resultsHTML += `
                    <div class="result-item">
                        <h3>${index + 1}. ${result.title}</h3>
                        ${result.xmlFile ? `<p><strong>Latest XML File:</strong> <a href="${result.xmlFile.url}" target="_blank">${result.xmlFile.url}</a></p>` : ''}
                        ${result.xmlFile && result.xmlFile.hour ? `<p><strong>Hour:</strong> ${result.xmlFile.hour}</p>` : ''}
                        ${result.stationCode ? `<p><strong>Station Code:</strong> ${result.stationCode.parsed.formatted} (${result.stationCode.parsed.stationNumber})</p>` : ''}
                        ${result.timestamp ? `<p><strong>Timestamp:</strong> ${result.timestamp.parsed.formatted}</p>` : ''}
                        ${result.context ? `<p><strong>Context:</strong> ${result.context}</p>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = resultsHTML;
        }
        
        let autoRefreshInterval = null;
        
        function startAutoRefresh() {
            const autoRefreshBtn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                // Stop auto-refresh
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                autoRefreshBtn.textContent = 'üîÑ Auto-Refresh Current Hour';
                autoRefreshBtn.style.backgroundColor = '#17a2b8';
                return;
            }
            
            // Start auto-refresh
            autoRefreshBtn.textContent = '‚èπÔ∏è Stop Auto-Refresh';
            autoRefreshBtn.style.backgroundColor = '#dc3545';
            
            // Initial scan
            scanCurrentHour();
            
            // Set up interval to scan every 5 minutes
            autoRefreshInterval = setInterval(() => {
                const now = new Date();
                const currentHour = now.getUTCHours().toString().padStart(2, '0');
                const currentTime = now.toUTCString();
                
                // Update the results area to show we're checking
                const resultsDiv = document.getElementById('results');
                const existingContent = resultsDiv.innerHTML;
                
                resultsDiv.innerHTML = `
                    <div class="loading">
                        üîÑ Auto-refreshing... Checking current hour (${currentHour}) at ${currentTime}
                    </div>
                    <hr>
                    <h4>Previous Results:</h4>
                    ${existingContent}
                `;
                
                // Perform the scan
                scanCurrentHour();
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // Check for station number in URL and redirect if found
        function checkForStationRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const stationNumber = urlParams.get('station');
            
            if (stationNumber) {
                // Validate station number format (s0000XXX)
                if (/^s\d{7}$/i.test(stationNumber)) {
                    // Check if this is a web service request (no HTML rendering)
                    const isWebService = urlParams.get('format') === 'json' || 
                                       urlParams.get('service') === 'true' ||
                                       urlParams.get('ws') === 'true' ||
                                       document.referrer === '' || 
                                       window.location.href.includes('null/') ||
                                       window.location.href.includes('tiiny.site') ||
                                       navigator.userAgent.includes('curl') ||
                                       navigator.userAgent.includes('wget') ||
                                       navigator.userAgent.includes('Postman') ||
                                       navigator.userAgent.includes('python') ||
                                       navigator.userAgent.includes('node') ||
                                       window.location.href.includes('api/') ||
                                       window.location.href.includes('webservice') ||
                                       window.location.href.includes('station=');
                    
                    if (isWebService) {
                        // Return JSON response for web service
                        handleWebServiceRequest(stationNumber);
                    } else {
                        // Normal HTML page behavior
                        redirectToLatestStationFile(stationNumber);
                    }
                } else {
                    showError(`Invalid station number format: ${stationNumber}. Expected format: s0000XXX`);
                }
            }
        }
        
        // Handle web service requests
        async function handleWebServiceRequest(stationNumber) {
            try {
                const baseUrl = 'https://dd.meteo.gc.ca/today/citypage_weather/QC/';
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                
                // Get current hour
                const now = new Date();
                const currentHour = now.getUTCHours().toString().padStart(2, '0');
                
                // Try current hour first
                let stationFiles = [];
                let foundHour = currentHour;
                let foundInCurrentHour = false;
                
                const currentHourUrl = baseUrl + currentHour + '/';
                try {
                    const response = await fetch(proxyUrl + encodeURIComponent(currentHourUrl));
                    if (response.ok) {
                        const htmlContent = await response.text();
                        const results = findXMLFiles(htmlContent, currentHourUrl);
                        
                        // Filter for the specific station and _fr.xml files only
                        stationFiles = results.xmlFiles.filter(file => 
                            (file.url.toLowerCase().includes(stationNumber.toLowerCase()) ||
                             file.context.toLowerCase().includes(stationNumber.toLowerCase())) &&
                            file.url.endsWith('_fr.xml')
                        );
                        
                        if (stationFiles.length > 0) {
                            foundInCurrentHour = true;
                            stationFiles.forEach(file => {
                                file.hour = currentHour;
                                file.sourceUrl = currentHourUrl;
                            });
                        }
                    }
                } catch (error) {
                    console.log(`Error checking current hour ${currentHour}:`, error);
                }
                
                // If not found in current hour, search previous hours
                if (!foundInCurrentHour) {
                    const hours = [];
                    for (let i = 1; i <= 24; i++) {
                        const hour = (currentHour - i + 24) % 24;
                        hours.push(hour.toString().padStart(2, '0'));
                    }
                    
                    for (const hour of hours) {
                        try {
                            const hourUrl = baseUrl + hour + '/';
                            const response = await fetch(proxyUrl + encodeURIComponent(hourUrl));
                            
                            if (response.ok) {
                                const htmlContent = await response.text();
                                const results = findXMLFiles(htmlContent, hourUrl);
                                
                                const hourFiles = results.xmlFiles.filter(file => 
                                    (file.url.toLowerCase().includes(stationNumber.toLowerCase()) ||
                                     file.context.toLowerCase().includes(stationNumber.toLowerCase())) &&
                                    file.url.endsWith('_fr.xml')
                                );
                                
                                if (hourFiles.length > 0) {
                                    foundHour = hour;
                                    stationFiles = hourFiles;
                                    stationFiles.forEach(file => {
                                        file.hour = hour;
                                        file.sourceUrl = hourUrl;
                                    });
                                    break;
                                }
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                        } catch (error) {
                            console.log(`Error checking hour ${hour}:`, error);
                            continue;
                        }
                    }
                }
                
                if (stationFiles.length > 0) {
                    // Get the latest file for this station
                    const latestFile = stationFiles.sort((a, b) => {
                        const aMatch = a.url.match(/(\d{8}T\d{6})/);
                        const bMatch = b.url.match(/(\d{8}T\d{6})/);
                        if (aMatch && bMatch) {
                            return bMatch[1].localeCompare(aMatch[1]);
                        }
                        return b.url.localeCompare(a.url);
                    })[0];
                    
                    // Return message with URL included
                    const message = `‚úÖ Found XML file for station ${stationNumber} in hour ${foundHour}${foundInCurrentHour ? ' (current hour)' : ' (previous hour)'}: ${latestFile.url}`;
                    document.head.innerHTML = '<meta http-equiv="Content-Type" content="text/plain; charset=utf-8">';
                    document.body.innerHTML = message;
                    document.title = `XML URL - Station ${stationNumber}`;
                    
                } else {
                    // Return error JSON response
                    const response = {
                        success: false,
                        station: stationNumber,
                        error: "No XML files found for station",
                        timestamp: new Date().toISOString(),
                        message: `No XML files were found for station ${stationNumber} in the current hour or any of the previous 24 hours`
                    };
                    
                    document.body.innerHTML = JSON.stringify(response, null, 2);
                    document.head.innerHTML = '<meta http-equiv="Content-Type" content="application/json">';
                }
                
            } catch (error) {
                const response = {
                    success: false,
                    station: stationNumber,
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    message: `Failed to find XML file for station ${stationNumber}`
                };
                
                document.body.innerHTML = JSON.stringify(response, null, 2);
                document.head.innerHTML = '<meta http-equiv="Content-Type" content="application/json">';
            }
        }
        
        async function redirectToLatestStationFile(stationNumber) {
            const resultsDiv = document.getElementById('results');
            
            // Get current hour
            const now = new Date();
            const currentHour = now.getUTCHours().toString().padStart(2, '0');
            const currentTime = now.toUTCString();
            
            resultsDiv.innerHTML = `<div class="loading">Finding XML file for station ${stationNumber} in current hour (${currentHour})...</div>`;
            
            try {
                const baseUrl = 'https://dd.meteo.gc.ca/today/citypage_weather/QC/';
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                
                // First try current hour
                let stationFiles = [];
                let foundHour = currentHour;
                let foundInCurrentHour = false;
                
                // Try current hour first
                const currentHourUrl = baseUrl + currentHour + '/';
                try {
                    const response = await fetch(proxyUrl + encodeURIComponent(currentHourUrl));
                    if (response.ok) {
                        const htmlContent = await response.text();
                        const results = findXMLFiles(htmlContent, currentHourUrl);
                        
                        // Filter for the specific station and _fr.xml files only
                        stationFiles = results.xmlFiles.filter(file => 
                            (file.url.toLowerCase().includes(stationNumber.toLowerCase()) ||
                             file.context.toLowerCase().includes(stationNumber.toLowerCase())) &&
                            file.url.endsWith('_fr.xml')
                        );
                        
                        if (stationFiles.length > 0) {
                            foundInCurrentHour = true;
                            stationFiles.forEach(file => {
                                file.hour = currentHour;
                                file.sourceUrl = currentHourUrl;
                            });
                        }
                    }
                } catch (error) {
                    console.log(`Error checking current hour ${currentHour}:`, error);
                }
                
                // If not found in current hour, search previous hours
                if (!foundInCurrentHour) {
                    resultsDiv.innerHTML = `<div class="loading">No XML found in current hour. Searching previous hours for station ${stationNumber}...</div>`;
                    
                    // Search through previous hours (going back up to 24 hours)
                    const hours = [];
                    for (let i = 1; i <= 24; i++) {
                        const hour = (currentHour - i + 24) % 24;
                        hours.push(hour.toString().padStart(2, '0'));
                    }
                    
                    for (const hour of hours) {
                        try {
                            const hourUrl = baseUrl + hour + '/';
                            const response = await fetch(proxyUrl + encodeURIComponent(hourUrl));
                            
                            if (response.ok) {
                                const htmlContent = await response.text();
                                const results = findXMLFiles(htmlContent, hourUrl);
                                
                                // Filter for the specific station and _fr.xml files only
                                const hourFiles = results.xmlFiles.filter(file => 
                                    (file.url.toLowerCase().includes(stationNumber.toLowerCase()) ||
                                     file.context.toLowerCase().includes(stationNumber.toLowerCase())) &&
                                    file.url.endsWith('_fr.xml')
                                );
                                
                                if (hourFiles.length > 0) {
                                    foundHour = hour;
                                    stationFiles = hourFiles;
                                    stationFiles.forEach(file => {
                                        file.hour = hour;
                                        file.sourceUrl = hourUrl;
                                    });
                                    break; // Found files, stop searching
                                }
                            }
                            
                            // Small delay to avoid overwhelming the server
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                        } catch (error) {
                            console.log(`Error checking hour ${hour}:`, error);
                            continue;
                        }
                    }
                }
                
                if (stationFiles.length > 0) {
                    // Get the latest file for this station
                    const latestFile = stationFiles.sort((a, b) => {
                        // Try to extract timestamp from URLs for sorting
                        const aMatch = a.url.match(/(\d{8}T\d{6})/);
                        const bMatch = b.url.match(/(\d{8}T\d{6})/);
                        if (aMatch && bMatch) {
                            return bMatch[1].localeCompare(aMatch[1]); // Latest first
                        }
                        return b.url.localeCompare(a.url); // Fallback to URL comparison
                    })[0];
                    
                    // Redirect to the latest XML file
                    window.location.href = latestFile.url;
                    
                    const hourStatus = foundInCurrentHour ? 'Current Hour' : `Previous Hour (${foundHour})`;
                    const hourMessage = foundInCurrentHour ? 
                        `Found <strong>${stationFiles.length}</strong> XML files for station <strong>${stationNumber}</strong> in current hour (${currentHour})` :
                        `Found <strong>${stationFiles.length}</strong> XML files for station <strong>${stationNumber}</strong> in hour ${foundHour} (most recent available)`;
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Redirected to ${hourStatus} XML File</h3>
                            <p>${hourMessage}</p>
                            <p><strong>Latest file:</strong> <a href="${latestFile.url}" target="_blank">${latestFile.url}</a></p>
                            <p><strong>Data Hour:</strong> ${foundHour} (${currentTime})</p>
                            <p><strong>Source:</strong> <a href="${latestFile.sourceUrl}" target="_blank">${latestFile.sourceUrl}</a></p>
                            ${!foundInCurrentHour ? `<p><em>Note: No data available in current hour (${currentHour}), showing most recent available data.</em></p>` : ''}
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå No XML files found for station</h3>
                            <p>No XML files were found for station <strong>${stationNumber}</strong> in the current hour (${currentHour}) or any of the previous 24 hours.</p>
                            <p>This could mean:</p>
                            <ul>
                                <li>The station hasn't reported data recently</li>
                                <li>The station number is incorrect</li>
                                <li>The station may be offline or not reporting</li>
                                <li>Data format may have changed</li>
                            </ul>
                            <p>Try scanning all hours manually to find any available data.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to find latest XML file for station ${stationNumber}: ${error.message}`);
            }
        }
        
        // Add station number input field
        function addStationRedirectUI() {
            const container = document.querySelector('.container');
            const existingStationDiv = document.getElementById('stationRedirectDiv');
            
            if (!existingStationDiv) {
                const stationDiv = document.createElement('div');
                stationDiv.id = 'stationRedirectDiv';
                stationDiv.className = 'input-group';
                stationDiv.innerHTML = `
                    <label for="stationInput">Quick Station Redirect:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="stationInput" placeholder="s0000123" style="flex: 1;">
                        <button onclick="redirectToStation()" style="background-color: #6f42c1; padding: 12px 16px;">üöÄ Go to Latest</button>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Enter station code (e.g., s0000123) to automatically find and open the latest XML file from the current hour
                    </small>
                `;
                
                // Insert after the hour selection
                const hourSelect = document.getElementById('hourSelect');
                hourSelect.parentNode.parentNode.insertBefore(stationDiv, hourSelect.parentNode.nextSibling);
            }
        }
        
        function redirectToStation() {
            const stationInput = document.getElementById('stationInput');
            const stationNumber = stationInput.value.trim();
            
            if (!stationNumber) {
                showError('Please enter a station number');
                return;
            }
            
            if (!/^s\d{7}$/i.test(stationNumber)) {
                showError('Invalid station number format. Expected format: s0000XXX');
                return;
            }
            
            redirectToLatestStationFile(stationNumber);
        }
        
        // Allow Enter key to trigger scan
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanForXML();
            }
        });
        
        // Initialize station redirect UI and check for URL parameters
        document.addEventListener('DOMContentLoaded', function() {
            // Check for station parameter first (before adding UI)
            const urlParams = new URLSearchParams(window.location.search);
            const stationNumber = urlParams.get('station');
            
            if (stationNumber) {
                // If station parameter exists, handle it immediately
                checkForStationRedirect();
            } else {
                // Only add UI if no station parameter
                addStationRedirectUI();
            }
        });
    </script>
</body>
</html>
